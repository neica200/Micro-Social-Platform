@model Micro_social_app.Models.Post

@{
    // fallback pentru avatar
    string initial = "?";
    if (Model.User != null && !string.IsNullOrEmpty(Model.User.UserName))
    {
        initial = Model.User.UserName.Substring(0, 1).ToUpper();
    }

    string fullName =
        Model.User?.Profile?.FullName
        ?? Model.User?.UserName
        ?? "User";

    string profileImg = Model.User?.Profile?.ProfileImageUrl ?? "";

    if (!string.IsNullOrEmpty(profileImg) &&
        !profileImg.StartsWith("/") &&
        !profileImg.StartsWith("http"))
    {
        profileImg = "/" + profileImg;
    }

    int commentsCount = Model.Comments?.Count ?? 0;
    int reactionsCount = Model.Reactions?.Count ?? 0;
}


<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">

            <div class="insta-post shadow-sm">

                <!-- HEADER -->
                <div class="insta-header">

                    <a asp-controller="Profiles"
                       asp-action="Index"
                       asp-route-userId="@Model.UserId"
                       class="text-decoration-none d-flex align-items-center gap-2">

                        @if (!string.IsNullOrEmpty(profileImg))
                        {
                            <img src="@profileImg" class="insta-avatar" alt="avatar" />
                        }
                        else
                        {
                            <div class="insta-avatar-fallback">@initial</div>
                        }
                    </a>

                    <div class="flex-grow-1">
                        <a asp-controller="Profiles"
                           asp-action="Index"
                           asp-route-userId="@Model.UserId"
                           class="text-decoration-none text-dark">
                            <div class="insta-username">@fullName</div>
                        </a>

                        <div class="insta-sub">
                            @Model.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        @if (ViewBag.IsLogged == true && ViewBag.CurrUser == Model.UserId)
                        {
                            <a class="btn btn-sm btn-outline-secondary"
                               asp-controller="Posts"
                               asp-action="Edit"
                               asp-route-id="@Model.Id">
                                Edit
                            </a>
                        }

                        @if (ViewBag.IsAdmin == true || ViewBag.CurrUser == Model.UserId)
                        {
                            <form method="post"
                                  asp-controller="Posts"
                                  asp-action="Delete"
                                  asp-route-id="@Model.Id">
                                @Html.AntiForgeryToken()
                                <button class="btn btn-sm btn-outline-danger" type="submit">
                                    Delete
                                </button>
                            </form>
                        }
                    </div>

                </div>

                <!-- MEDIA -->
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="@Model.ImageUrl" class="insta-media" alt="post image" />
                }
                else if (!string.IsNullOrEmpty(Model.VideoUrl))
                {
                    <video class="insta-media" controls>
                        <source src="@Model.VideoUrl" />
                    </video>
                }

                <!-- ACTIONS + LIKES + CAPTION + VIEW COMMENTS (ca in Index) -->
                <div class="card-body">

                    <!-- ACTION BAR -->
                    <div class="ig-actions-row">
                        <button type="button" class="ig-icon-btn" title="Like">
                            <i class="bi bi-heart"></i>
                        </button>

                        <a href="#comments"
                           class="ig-icon-btn ig-icon-link"
                           title="Comment">
                            <i class="bi bi-chat"></i>
                        </a>

                        <button type="button"
                                class="ig-icon-btn ms-auto"
                                title="Share">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>

                    <!-- LIKES -->
                    <div class="ig-likes">
                        @reactionsCount likes
                    </div>

                    <!-- CAPTION -->
                    @if (!string.IsNullOrEmpty(Model.Content))
                    {
                        <div class="ig-caption">
                            <span class="ig-caption-user">@fullName</span>
                            <span class="ig-caption-text">@Model.Content</span>
                        </div>
                    }

                    <!-- COMMENTS LINK -->
                    <a href="#comments" class="ig-view-comments">
                        @(commentsCount > 0 ? $"View all {commentsCount} comments" : "Add a comment…")
                    </a>

                </div>

                <hr class="insta-divider" />

                <!-- COMMENTS -->
                <div class="insta-comments" id="comments">
                    @if (commentsCount == 0)
                    {
                        <p class="text-muted mb-0">No comments.</p>
                    }
                    else
                    {
                        @foreach (var comment in Model.Comments)
                        {
                            <div class="comment-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="comment-user">@comment.User?.UserName</span>
                                        <span>@comment.Content</span>

                                        <div class="comment-time">
                                            @comment.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                                        </div>
                                    </div>

                                    @if (ViewBag.IsAdmin == true || ViewBag.CurrUser == comment.UserId)
                                    {
                                        <form method="post"
                                              asp-controller="Comments"
                                              asp-action="Delete"
                                              asp-route-id="@comment.Id">
                                            @Html.AntiForgeryToken()
                                            <button class="btn btn-sm btn-outline-danger" type="submit">
                                                Sterge
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- ADD COMMENT -->
                <div class="insta-input">
                    @if (ViewBag.IsLogged == true)
                    {
                        <form method="post"
                              asp-controller="Comments"
                              asp-action="New">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="PostId" value="@Model.Id" />

                            <div class="d-flex gap-2">
                                <input name="Content"
                                       class="form-control"
                                       placeholder="Add a comment..." />

                                <button class="btn btn-primary" type="submit">
                                    Post
                                </button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="text-muted text-center">
                            Trebuie sa fii logat pentru a adauga comentarii.
                        </div>
                    }
                </div>

            </div>

        </div>
    </div>
</div>



@* @model Micro_social_app.Models.Post

@{
    // fallback pentru avatar
    string initial = "?";
    if (Model.User != null && !string.IsNullOrEmpty(Model.User.UserName))
    {
        initial = Model.User.UserName.Substring(0, 1).ToUpper();
    }

    string fullName =
        Model.User?.Profile?.FullName
        ?? Model.User?.UserName
        ?? "User";

    string profileImg = Model.User?.Profile?.ProfileImageUrl ?? "";

    if (!string.IsNullOrEmpty(profileImg) &&
        !profileImg.StartsWith("/") &&
        !profileImg.StartsWith("http"))
    {
        profileImg = "/" + profileImg;
    }
}


<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">

            <div class="insta-post shadow-sm">

                <!-- HEADER -->
                <div class="insta-header">

                    <a asp-controller="Profiles"
                       asp-action="Index"
                       asp-route-userId="@Model.UserId"
                       class="text-decoration-none d-flex align-items-center gap-2">

                        @if (!string.IsNullOrEmpty(profileImg))
                        {
                            <img src="@profileImg" class="insta-avatar" alt="avatar" />
                        }
                        else
                        {
                            <div class="insta-avatar-fallback">@initial</div>
                        }
                    </a>

                    <div class="flex-grow-1">
                        <a asp-controller="Profiles"
                           asp-action="Index"
                           asp-route-userId="@Model.UserId"
                           class="text-decoration-none text-dark">
                            <div class="insta-username">@fullName</div>
                        </a>

                        <div class="insta-sub">
                            @Model.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        @if (ViewBag.IsLogged == true && ViewBag.CurrUser == Model.UserId)
                        {
                            <a class="btn btn-sm btn-outline-secondary"
                               asp-controller="Posts"
                               asp-action="Edit"
                               asp-route-id="@Model.Id">
                                Edit
                            </a>
                        }

                        @if (ViewBag.IsAdmin == true || ViewBag.CurrUser == Model.UserId)
                        {
                            <form method="post"
                                  asp-controller="Posts"
                                  asp-action="Delete"
                                  asp-route-id="@Model.Id">
                                @Html.AntiForgeryToken()
                                <button class="btn btn-sm btn-outline-danger" type="submit">
                                    Delete
                                </button>
                            </form>
                        }
                    </div>

                </div>

                <!-- MEDIA -->
                @if (!string.IsNullOrEmpty(Model.ImageUrl))
                {
                    <img src="@Model.ImageUrl" class="insta-media" alt="post image" />
                }
                else if (!string.IsNullOrEmpty(Model.VideoUrl))
                {
                    <video class="insta-media" controls>
                        <source src="@Model.VideoUrl" />
                    </video>
                }

                <!-- ACTIONS -->
                <div class="insta-actions">
                    <button class="insta-icon-btn" type="button" title="Like">
                        ❤️
                    </button>

                    <span class="insta-sub">
                        @Model.Reactions.Count likes · @Model.Comments.Count comments
                    </span>
                </div>

                <hr class="insta-divider" />

                <!-- CAPTION -->
                <div class="insta-meta">
                    @if (!string.IsNullOrEmpty(Model.Content))
                    {
                        <div class="insta-caption">
                            <span class="insta-caption-user">@fullName</span>
                            <span class="insta-caption-text">@Model.Content</span>
                        </div>

                        
                    }


                </div>

                <hr class="insta-divider" />

                <!-- COMMENTS -->
                <div class="insta-comments">
                    @if (Model.Comments.Count == 0)
                    {
                        <p class="text-muted mb-0">No comments.</p>
                    }
                    else
                    {
                        @foreach (var comment in Model.Comments)
                        {
                            <div class="comment-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="comment-user">@comment.User.UserName</span>
                                        <span>@comment.Content</span>

                                        <div class="comment-time">
                                            @comment.CreatedAt.ToLocalTime().ToString("dd MMM yyyy, HH:mm")
                                        </div>
                                    </div>

                                    @if (ViewBag.IsAdmin == true || ViewBag.CurrUser == comment.UserId)
                                    {
                                        <form method="post"
                                              asp-controller="Comments"
                                              asp-action="Delete"
                                              asp-route-id="@comment.Id">
                                            @Html.AntiForgeryToken()
                                            <button class="btn btn-sm btn-outline-danger" type="submit">
                                                Sterge
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>

                <!-- ADD COMMENT -->
                <div class="insta-input">
                    @if (ViewBag.IsLogged == true)
                    {
                        <form method="post"
                              asp-controller="Comments"
                              asp-action="New">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="PostId" value="@Model.Id" />

                            <div class="d-flex gap-2">
                                <input name="Content"
                                       class="form-control"
                                       placeholder="Add a comment..." />

                                <button class="btn btn-primary" type="submit">
                                    Post
                                </button>
                            </div>
                        </form>
                    }
                    else
                    {
                        <div class="text-muted text-center">
                            Trebuie sa fii logat pentru a adauga comentarii.
                        </div>
                    }
                </div>

            </div>

        </div>
    </div>
</div>

 *@

